{{extend 'layout.html'}}


{{ if confirm: }}
  <link rel="stylesheet" type="text/css" href="{{=URL('static', 'css/datepicker.css')}}" />
  <script src="{{=URL('static', 'js/bootstrap-datepicker.js')}}"></script>
  <h3>Rebuild your course</h3>

  <p>This will update your course with the latest changes to the content and layout.
    Are you sure you want to do this?
  </p>

  <form name="confirm" method="POST" action="/{{=request.application}}/admin/rebuildcourse">
   <input type="hidden" name="projectname" value="{{= auth.user.course_name}}" />
   <input type="hidden" name="coursetype" value="rebuildcourse" />
   <input type="checkbox" name="loginreq" value="yes" checked /> Require a username to access this course <br>
   Course start date: <input type="text" name="startdate" id="datepicker" data-date-format="mm/dd/yyyy" value="{{=curr_start_date}}" /><br /><br />
   <input type="submit" class="btn btn-small" value="Rebuild" />
  </form>
  <script type="text/javascript">
    $("#datepicker").datepicker();
  </script>

{{ else: }}
  <h3 id="title">Rebuilding course.</h3>
  <div id="spinner_div" class='pull-left' style="align: center; margin-right: 20px;">
	  <img id="spinner" src="/{{=request.application}}/static/images/spinner10.gif">
  </div>
  <p id="message">Your course is being rebuilt. This may take several minutes to complete.
   <b>Please do not refresh the page.</b> When the rebuild is finished, you will be redirected to
   your newly rebuilt course.</p>

  <script type="text/javascript">
    
    var iid = setInterval(function() {
      d = { task_name:'{{ =task_name }}',
            course_url:'{{ =course_url }}'};
      $.post(eBookConfig.ajaxURL+'getSphinxBuildStatus.json', d, function(data) {
        if (data.status == "true") {
          window.location.href = data.course_url;
        }
        if (data.status == "failed") {
          $("#spinner_div").hide();
          $("#title").text("Permission denied.");
          $("#message").text("You don't have permission to rebuild this course.");
        }
      });
    }, 3000);
  </script>
{{ pass }}